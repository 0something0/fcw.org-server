From abfe7bcb1b4d90a7f9c3b42169727a6c3954ff23 Mon Sep 17 00:00:00 2001
From: Sveinung Kvilhaugsvik <sveinung84@users.sourceforge.net>
Date: Sun, 28 Sep 2014 15:29:38 +0200
Subject: [PATCH] Bribe Unit: Diplomat battle any other capable unit on the
 target's tile.

Requested by Marko Lindqvist <cazfi>
---
 server/diplomats.c | 43 +++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 43 insertions(+)

diff --git a/server/diplomats.c b/server/diplomats.c
index 0e86e9a..b8e6759 100644
--- a/server/diplomats.c
+++ b/server/diplomats.c
@@ -55,6 +55,11 @@ static bool diplomat_infiltrate_tile(struct player *pplayer,
                                      struct player *cplayer,
                                      struct unit *pdiplomat,
                                      struct tile *ptile);
+static bool diplomat_infiltrate_tile_victim(struct player *pplayer,
+                                            struct player *cplayer,
+                                            struct unit *pdiplomat,
+                                            struct unit *pvictim,
+                                            struct tile *ptile);
 static void diplomat_escape(struct player *pplayer, struct unit *pdiplomat,
                             const struct city *pcity);
 static void diplomat_escape_full(struct player *pplayer,
@@ -456,6 +461,16 @@ void diplomat_bribe(struct player *pplayer, struct unit *pdiplomat,
     return;
   }
 
+  log_debug("bribe-unit: enough gold");
+
+  /* Diplomatic battle against any diplomatic defender except the one that
+   * will get the bribe. */
+  if (!diplomat_infiltrate_tile_victim(pplayer, uplayer,
+                                       pdiplomat, pvictim,
+                                       pvictim->tile)) {
+    return;
+  }
+
   log_debug("bribe-unit: succeeded");
 
   victim_tile = unit_tile(pvictim);
@@ -1266,6 +1281,29 @@ static bool diplomat_infiltrate_tile(struct player *pplayer,
                                      struct unit *pdiplomat,
                                      struct tile *ptile)
 {
+  return diplomat_infiltrate_tile_victim(pplayer, cplayer,
+                                         pdiplomat, NULL,
+                                         ptile);
+}
+
+/**************************************************************************
+  This determines if a diplomat/spy succeeds in infiltrating a tile.
+
+  - The infiltrator must go up against each defender.
+  - The victim unit won't defend.
+  - One or the other is eliminated in each contest.
+
+  - Return TRUE if the infiltrator succeeds.
+
+  'pplayer' is the player who tries to do a spy/diplomat action on 'ptile'
+  with the unit 'pdiplomat' against 'cplayer'.
+**************************************************************************/
+static bool diplomat_infiltrate_tile_victim(struct player *pplayer,
+                                            struct player *cplayer,
+                                            struct unit *pdiplomat,
+                                            struct unit *pvictim,
+                                            struct tile *ptile)
+{
   char link_city[MAX_LEN_LINK] = "";
   char link_diplomat[MAX_LEN_LINK];
   char link_unit[MAX_LEN_LINK];
@@ -1286,6 +1324,11 @@ static bool diplomat_infiltrate_tile(struct player *pplayer,
       continue;
     }
 
+    /* This victim is, by ability or by will, defenseless. */
+    if (punit == pvictim) {
+      continue;
+    }
+
     if (unit_has_type_flag(punit, UTYF_DIPLOMAT)
         || unit_has_type_flag(punit, UTYF_SUPERSPY)) {
       /* A UTYF_SUPERSPY unit may not actually be a spy, but a superboss
-- 
2.1.0

